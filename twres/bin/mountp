#!/bin/bash
readonly VIEW_HEIGHT=18

stty_orig="$(stty -g)"
trap 'stty "$stty_orig"; printf "\033c"' EXIT INT TERM

readonly REBOOT_MENU_OPTIONS=(
    "Mount internal" "twrp mount data"
    "Mount exteral (not tested)" "twrp mount external_sd"
    "Mount usb otg (not tested)" "twrp mount usb-otg"
    "Mount system" "twrp mount system"
    "Mount system ext (not tested)" "twrp mount system_ext"
    "Mount vendor" "twrp mount vendor"
    "Mount product" "twrp mount product"
    "Mount odm" "twrp mount odm"
)
readonly OPTION_COUNT=$(( ${#REBOOT_MENU_OPTIONS[@]} / 2 ))

main_reboot_menu() {
    
    local selected_index=0
    
    while true; do
        printf "\033c"
        printf "_MOUNT MENU\n"
        printf "=================================\n"
        printf "Select action to perform:\n"

        for ((i=0; i < OPTION_COUNT; i++)); do
            local display_name="${REBOOT_MENU_OPTIONS[i*2]}"
            if [[ "$i" -eq "$selected_index" ]]; then
                printf "> \033[7m%s\033[0m\n" "$display_name"
            else
                printf "  %s\n" "$display_name"
            fi
        done
        
        local lines_printed="$OPTION_COUNT"
        for (( j = lines_printed; j < VIEW_HEIGHT; j++ )); do
            echo
        done

        printf "=================================\n"
        printf "[vol+] Up | [vol-] Down | [power] Select | [power+vol-] Quit\n"

        stty -echo -icanon
        read -n 1 menu_key
        stty "$stty_orig"

        case "$menu_key" in
            j)
                if [ "$selected_index" -lt "$((OPTION_COUNT - 1))" ]; then
                    selected_index=$((selected_index + 1))
                fi
                ;;
            k)
                if [ "$selected_index" -gt 0 ]; then
                    selected_index=$((selected_index - 1))
                fi
                ;;
            l | $'\r' | $'\n')
                local command="${REBOOT_MENU_OPTIONS[selected_index*2 + 1]}"
                
                printf "\033c"
                
                if [ "$command" = "exit" ]; then
                    echo "Exiting menu."
                    exit 0
                fi
                
                echo "Executing: $command"
                $command
                
				echo "Press any key to return to the menu..."
                read -n 1 wait_key
                ;;
            q)
                break
                ;;
        esac
    done
}

main_reboot_menu

exit 0